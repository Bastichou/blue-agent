# Fetch the vendor with the builder platform to avoid QEMU issues
FROM --platform=$BUILDPLATFORM registry.access.redhat.com/ubi8/ubi-minimal:8.7

# Install:
# - Azure Pipelines agent system requirements
# - ASP.NET Core runtime
# - "gzip, make, tar, unzip, wget, zip, zsh, zstd" for developer ease-of-life
RUN microdnf install -y --refresh --nodocs --setopt=install_weak_deps=0 \
        aspnetcore-runtime-6.0 \
        ca-certificates \
        curl \
        git-core \
        git-lfs \
        gnupg \
        gzip \
        hostname \
        iputils \
        jq \
        make \
        tar \
        unzip \
        wget \
        zip \
        zsh \
        zstd \
    && microdnf clean all \
    && rm -rf /var/cache/yum

# Install Azure CLI with RPM, then verify installation
RUN rpm --import https://packages.microsoft.com/keys/microsoft.asc \
    && curl -sL https://packages.microsoft.com/config/rhel/8/prod.repo > /etc/yum.repos.d/azure-cli.repo \
    && microdnf install -y --refresh --nodocs --setopt=install_weak_deps=0 \
        azure-cli \
    && microdnf clean all \
    && rm -rf /var/cache/yum \
    && az --version

WORKDIR /azp

# Install Azure Pipelines Agent sources, then verify installation
ARG AGENT_VERSION
ENV AGENT_VERSION ${AGENT_VERSION}
COPY init.sh .
RUN chmod +x init.sh \
    && ./init.sh $AGENT_VERSION \
    && AGENT_ALLOW_RUNASROOT="1" ./run-docker.sh --version

# Install Azure Pipelines Agent startup script
COPY start.sh .
RUN chmod +x start.sh

CMD ["./start.sh"]
